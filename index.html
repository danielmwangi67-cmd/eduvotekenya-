<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduVote Kenya | Student Code Generator</title>
<style>
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  overflow: hidden;
  height: 100vh;
  background: black;
  position: relative;
  color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

canvas { position: absolute; top: 0; left: 0; z-index: 0; }

.box {
  position: relative; z-index: 3;
  padding: 40px;
  border-radius: 20px;
  background: rgba(0,0,0,0.6);
  text-align: center;
  max-width: 450px;
  box-shadow: 0 0 25px rgba(255,255,255,0.2);
}

h1 {
  font-size: 2em;
  color: #fff;
  margin-bottom: 20px;
  text-shadow: 0 0 10px #fff, 0 0 20px #f0f, 0 0 30px #0ff;
}

input {
  padding: 12px;
  border-radius: 10px;
  border: none;
  width: 250px;
  text-align: center;
  font-size: 16px;
  margin-top: 10px;
}

button {
  display: block;
  margin: 20px auto 0;
  padding: 12px 25px;
  border: none;
  border-radius: 50px;
  font-weight: bold;
  font-size: 16px;
  color: #fff;
  background: linear-gradient(45deg, #FFD700, #2575fc);
  cursor: pointer;
  box-shadow: 0 5px 20px rgba(0,0,0,0.4);
  transition: transform 0.3s, box-shadow 0.3s;
}

button:hover {
  transform: scale(1.1) rotate(-2deg);
  box-shadow: 0 8px 25px rgba(0,0,0,0.6);
}

#message {
  margin-top: 20px;
  font-weight: bold;
  transition: opacity 1s ease;
}
</style>
</head>
<body>

<canvas id="nebulaCanvas"></canvas>
<canvas id="bgStars"></canvas>

<div class="box">
  <h1>🌌 EduVote Kenya – Student Code Generator 🌌</h1>
  <input type="text" id="code" placeholder="Enter School Code">
  <button id="generateBtn">Generate Student Codes</button>
  <button id="backBtn" style="display:none;">Return to Dashboard</button>
  <div id="message"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzd8PXLdhQAvwmxGodU01zh90B5REZfUybkA_bhBkU55_BwSF2og20VZhP8w-mvzVUg/exec"; // Apps Script
const dashboardURL = "https://www.eduvotekenya.co.ke/home"; // Dashboard

const nebulaCanvas = document.getElementById('nebulaCanvas');
const nebCtx = nebulaCanvas.getContext('2d');
const canvas = document.getElementById('bgStars');
const ctx = canvas.getContext('2d');

let stars = [], shootingStars = [], nebulaClouds = [];
const numStars = 200, numShooting = 2, numNebula = 5;

function resizeCanvas() {
  canvas.width = nebulaCanvas.width = window.innerWidth;
  canvas.height = nebulaCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function createStars() {
  stars = [];
  for (let i=0;i<numStars;i++){
    const size=Math.random()*2+0.5;
    stars.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      radius:size,
      color:`hsl(${Math.random()*360},80%,70%)`,
      dx:(Math.random()-0.5)*0.3,
      dy:(Math.random()-0.5)*0.3,
      alpha:Math.random()*0.8+0.2,
      dAlpha:Math.random()*0.02
    });
  }
}

function createShootingStars(){
  shootingStars = [];
  for(let i=0;i<numShooting;i++){
    shootingStars.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height/2,
      length: Math.random()*100+50,
      speed: Math.random()*8+4,
      angle: Math.random()*0.2-0.1,
      color: 'white'
    });
  }
}

function createNebula(){
  nebulaClouds = [];
  for(let i=0;i<numNebula;i++){
    nebulaClouds.push({
      x: Math.random()*nebulaCanvas.width,
      y: Math.random()*nebulaCanvas.height,
      radius: Math.random()*300+200,
      color: `hsla(${Math.random()*360},60%,50%,0.15)`,
      dx: (Math.random()-0.5)*0.2,
      dy: (Math.random()-0.5)*0.1
    });
  }
}

function drawNebula(){
  nebCtx.clearRect(0,0,nebulaCanvas.width,nebulaCanvas.height);
  for(let cloud of nebulaClouds){
    const grad = nebCtx.createRadialGradient(cloud.x, cloud.y, 0, cloud.x, cloud.y, cloud.radius);
    grad.addColorStop(0, cloud.color);
    grad.addColorStop(1,'rgba(0,0,0,0)');
    nebCtx.fillStyle=grad;
    nebCtx.beginPath();
    nebCtx.arc(cloud.x, cloud.y, cloud.radius,0,Math.PI*2);
    nebCtx.fill();
    cloud.x += cloud.dx; cloud.y += cloud.dy;
    if(cloud.x<-cloud.radius) cloud.x=nebulaCanvas.width+cloud.radius;
    if(cloud.x>nebulaCanvas.width+cloud.radius) cloud.x=-cloud.radius;
    if(cloud.y<-cloud.radius) cloud.y=nebulaCanvas.height+cloud.radius;
    if(cloud.y>nebulaCanvas.height+cloud.radius) cloud.y=-cloud.radius;
  }
  requestAnimationFrame(drawNebula);
}

function drawStars(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let s of stars){
    const grad=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.radius*3);
    grad.addColorStop(0,`rgba(255,255,255,${s.alpha})`);
    grad.addColorStop(0.5,s.color);
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.radius,0,Math.PI*2);
    ctx.fill();
    s.x+=s.dx;s.y+=s.dy;s.alpha+=s.dAlpha;
    if(s.alpha<=0.2||s.alpha>=1) s.dAlpha*=-1;
    if(s.x<0) s.x=canvas.width;
    if(s.x>canvas.width) s.x=0;
    if(s.y<0) s.y=canvas.height;
    if(s.y>canvas.height) s.y=0;
  }
  for(let s of shootingStars){
    ctx.beginPath();
    ctx.moveTo(s.x,s.y);
    ctx.lineTo(s.x-s.length*s.angle,s.y+s.length);
    ctx.strokeStyle=s.color; ctx.lineWidth=2;
    ctx.shadowBlur=15; ctx.shadowColor='white';
    ctx.stroke();
    s.x+=s.speed; s.y+=s.speed*s.angle;
    if(s.x>canvas.width || s.y>canvas.height/2){ s.x=Math.random()*canvas.width; s.y=Math.random()*canvas.height/2;}
  }
  requestAnimationFrame(drawStars);
}

createStars(); createShootingStars(); createNebula();
drawNebula(); drawStars();

const starColors = ['#FFD700','#FF4500','#00FFFF','#FF69B4','#ADFF2F'];

function launchConfetti() {
  confetti({
    particleCount: 200,
    spread: 140,
    origin: { y: 0.6 },
    shapes: ['star'],
    colors: starColors,
    scalar: 1
  });
}

// ==== Generate Student Codes ====
const generateBtn = document.getElementById('generateBtn');
const backBtn = document.getElementById('backBtn');
const msg = document.getElementById('message');

generateBtn.addEventListener('click', async () => {
  const codeInput = document.getElementById('code').value.trim();
  if(!codeInput){ msg.textContent="Please enter school code"; msg.style.color="orange"; fadeMessage(msg); return; }

  msg.textContent = "Processing..."; msg.style.color="#00ffcc";

  try {
    const res = await fetch(`${scriptURL}?action=generateStudentCodes&code=${encodeURIComponent(codeInput)}`);
    const text = await res.text();
    if(text.includes("❌")){ msg.textContent=text; msg.style.color="red"; fadeMessage(msg); }
    else{
      msg.textContent="✅ Student codes generated! Downloading CSV..."; msg.style.color="#00ff88";
      launchConfetti();
      const blob = new Blob([text], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download="StudentCodes.csv"; a.click();
      URL.revokeObjectURL(url);
      backBtn.style.display="block";
    }
  } catch(err){
    msg.textContent="⚠️ Error connecting to server. Check Apps Script deployment"; msg.style.color="orange"; fadeMessage(msg);
    console.error(err);
  }
});

backBtn.addEventListener('click', ()=>{
  launchConfetti();
  setTimeout(()=>{ window.location.href=dashboardURL; },500);
});

function fadeMessage(el){ el.style.opacity=1; setTimeout(()=>{ el.style.opacity=0; },3000); }

</script>
</body>
</html>










